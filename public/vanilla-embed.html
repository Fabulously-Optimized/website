<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Fabulously Optimized for Minecraft Launcher</title>

	<link rel="stylesheet" href="./assets/css/bulma.min.css">
</head>

<body>
	<style>
		html, body {
			background-color: transparent;
		}

		#title {
			padding: 0.5em;
			font-size: 2em;
		}

		button{
			min-width: 20vw;
		}

		#versionListDiv {
			padding: 1em;
		}

		#downloadLatest {
			font-size: 1.5em;
		}

		#versionsList > li
		{
			padding-top: 1em;
		}

		#olderVersions {
			margin-top: 1em;
		}

		#versionsList > li > button {
			font-size: 1em;
		}

		#footer {
			padding: 1em;
		}
	</style>
    <div id="versionListDiv">
        <select id="versionsDropdown"></select>
        <button id="goButton">⬇️</button>
    </div>

	<div id="loading-modal" class="modal">
		<div class="modal-background"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">Downloading pack</p>
			</header>
			<section class="modal-card-body">
				<p>
					Files required for the modpack are currently being downloaded, please wait.
				</p>
			</section>
			<footer class="modal-card-foot">
				<progress id="loading-progress" class="progress is-primary" value="0" max="100">0%</progress>
			</footer>
		</div>
	</div>

	<script>
		async function loadVersionsFromURL(url) {
		    try {
		        const response = await fetch(url);
		        const data = await response.json();
		        return data;
		    } catch (error) {
		        console.error('Error loading data:', error);
		        return null;
		    }
		}

		function isVersionAllowed(version, minVersion = '1.19.4') {
			version = version.split('.').map(Number);  // split the versions string into an array of numbers ex (1.19.4 -> [1, 19, 4])
			minVersion = minVersion.split('.').map(Number);

			for (let i = 0; i < Math.max(version.length, minVersion.length); i++) {  // check witch version is higher
				const num1 = version[i] || 0;
				const num2 = minVersion[i] || 0;

				if (num1 > num2) return true;
				if (num1 < num2) return false;
			}
			return true; // Return true if versions are equal
		}

		function groupByGameVersions(data) {
		    const groupedVersion = {};

		    data.forEach(item => { //forEach FO release
		        item.game_versions.forEach(version => { // for each compatible mc_version of said release
		            if (isVersionAllowed(version)) { // if it's not less than 1.19.4 (such older versions have to be downloaded from curseforge)
		                if (!groupedVersion[version]) {      // if we don't have an array for this minecraft_version yet create one
		                    groupedVersion[version] = [];
		                }
		                groupedVersion[version].push(item); // add the release to the minecraft_version array
		            }
		        });
		    });

		    return groupedVersion;
		}

		function getVersionToDisplay(groupedVersion) {
		    // If the latest version is a release, display only it
		    // If the latest version is a beta, display it and the newest stable release available
		    // If the latest version is an alpha, display it, the newest beta available and the newest stable release available
		    const versionsToDisplay = [];

		    for (const version in groupedVersion) {
		        if (groupedVersion[version].length > 0) {
		            let firstAlpha = null;
		            let firstBeta = null;
		            let firstRelease = null;

		            for (const item of groupedVersion[version]) {
		                if (!item.name.toLowerCase().includes('alpha') && !item.name.toLowerCase().includes('beta')) {
		                    firstRelease = item;
		                    break;
		                } else if (item.name.toLowerCase().includes('beta') && !firstBeta) {
		                    firstBeta = item;
		                } else if (item.name.toLowerCase().includes('alpha') && !firstAlpha && !firstBeta) {
		                    firstAlpha = item;
		                    for (const subItem of groupedVersion[version]) {
		                        if (subItem.name.toLowerCase().includes('beta') && !firstBeta) {
		                            firstBeta = subItem;
		                        } else if (!subItem.name.toLowerCase().includes('alpha') && !subItem.name.toLowerCase().includes('beta') && !firstRelease) {
		                            firstRelease = subItem;
		                        }
		                        if (firstBeta && firstRelease) {
		                            break;
		                        }
		                    }
		                }
		            }
		            if (firstAlpha) versionsToDisplay.push(firstAlpha);
		            if (firstBeta) versionsToDisplay.push(firstBeta);
		            if (firstRelease) versionsToDisplay.push(firstRelease);

		        }
		    }
			// Sort versionsToDisplay by the number after the "for", to make newer versions appear first
			versionsToDisplay.sort((a, b) => {
			    const extractNumber = (name) => {
			        const match = name.match(/for\s*([\d. ]+)/i); // Match "for" followed by numbers, dots, and spaces
			        if (match) {
			            return match[1].replace(/[. ]/g, ''); // Remove dots and spaces
			        }
			        return '';
			    };

			    const numA = extractNumber(a.name);
			    const numB = extractNumber(b.name);

			    return numB.localeCompare(numA, undefined, { numeric: true }); // Swap numA and numB to invert the sorting order
			});
		    return versionsToDisplay;
		}

		function populateDropdownAndSetupButton(versions) {
		    const versionsDropdown = document.getElementById('versionsDropdown');

		    versions.forEach(version => {
		        const option = document.createElement('option');
		        option.textContent = version.name;
		        option.value = version.files[0].url;
		        versionsDropdown.appendChild(option);
		    });

		    const specialOption = document.createElement('option');
		    specialOption.textContent = '4.6.1, 4.5.7, ...';
		    specialOption.value = 'CurseForge';
		    versionsDropdown.appendChild(specialOption);

		    // Set up the "Go" button to download the selected pack or open the URL
		    const goButton = document.getElementById('goButton');
		    goButton.onclick = () => {
		        const selectedURL = versionsDropdown.value;
		        if (selectedURL === 'CurseForge') {
		            window.open("https://www.curseforge.com/minecraft/modpacks/fabulously-optimized/files?showAlphaFiles=show", '_blank');
		        } else {
		            downloadPack(selectedURL);
		        }
		    };
		}

		const apiUrl = 'https://api.modrinth.com/v2/project/1KVo5zza/version';

		const urlParams = new URLSearchParams(window.location.search);
		const downloadParam = urlParams.get('download');
		const downloadLatestButtonVanilla = document.getElementById('downloadLatest');

		loadVersionsFromURL(apiUrl)
		    .then(data => {
		        if (data) {
		            const groupedVersion = groupByGameVersions(data);
		            const versionsToDisplay = getVersionToDisplay(groupedVersion);
		            populateDropdownAndSetupButton(versionsToDisplay);
		            if (downloadParam === 'latest') {
		                // Download the first (newest) item
		                downloadPack(versionsToDisplay[0].files[0].url);
		            } else if (downloadParam) {
		                // Download specific version based on query parameter
		                const foundVersion = versionsToDisplay.find(version => version.game_versions[0] === downloadParam);
		                if (foundVersion) {
		                    downloadPack(foundVersion.files[0].url);
		                } else {
		                    alert('Requested version not found');
		                }
		            }
		        } else {
		            console.error('Failed to load data');
		        }
		    })
		    .catch(error => console.error('Error:', error));
	</script>

	<script src="./assets/js/FileSaver.min.js"></script>
	<script src="./assets/js/jszip.min.js"></script>
	<script src="./assets/js/jszip-utils.min.js"></script>
	<script src="./assets/js/converter.js"></script>

</body>

</html>